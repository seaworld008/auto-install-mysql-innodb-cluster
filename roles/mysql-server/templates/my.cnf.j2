# MySQL 8.0 Configuration for InnoDB Cluster - Production Optimized
# Generated by Ansible
# Hardware Profile: {{ mysql_hardware_profile }}

[mysqld]
# Basic Settings
user = {{ mysql_user }}
port = {{ mysql_port }}
mysqlx_port = {{ mysql_admin_port }}
server_id = {{ mysql_server_id }}
datadir = {{ mysql_datadir }}
socket = {{ mysql_datadir }}/mysql.sock
pid_file = /var/run/mysqld/mysqld.pid
log_error = {{ mysql_logdir }}/mysqld.log
tmpdir = {{ mysql_tmpdir }}

# Character Set
character_set_server = utf8mb4
collation_server = utf8mb4_general_ci

# Connection Settings - Production Optimized for High Concurrency
max_connections = {{ mysql_max_connections }}
max_user_connections = {{ mysql_max_connections - 100 }}    # 为管理连接预留100个
max_connect_errors = 100000
back_log = {{ (mysql_max_connections * 0.1) | int }}        # 连接队列大小，10%的max_connections
thread_cache_size = {{ mysql_thread_cache_size }}
thread_stack = 512K                                         # 增加线程栈大小支持高并发
table_open_cache = {{ mysql_table_open_cache }}
table_definition_cache = {{ (mysql_table_open_cache * 0.5) | int }}
table_open_cache_instances = 16                             # 分片table cache减少锁竞争
open_files_limit = {{ mysql_max_connections * 5 }}          # 文件描述符限制，连接数的5倍
max_allowed_packet = 1073741824                            # 1GB，支持大数据包
net_buffer_length = 32768                                  # 网络缓冲区大小
thread_handling = one-thread-per-connection                # 一线程一连接模式

# Connection Timeout Settings
interactive_timeout = 3600
wait_timeout = 3600
connect_timeout = 10
net_read_timeout = 30
net_write_timeout = 60

# Query Cache (MySQL 8.0 deprecated, but keeping for compatibility)
# query_cache_type = 1
# query_cache_size = {{ mysql_query_cache_size }}

# Buffer Settings - Production Optimized
sort_buffer_size = {{ mysql_sort_buffer_size }}
read_buffer_size = {{ mysql_read_buffer_size }}
read_rnd_buffer_size = {{ mysql_read_rnd_buffer_size }}
bulk_insert_buffer_size = {{ mysql_bulk_insert_buffer_size }}
join_buffer_size = {{ mysql_sort_buffer_size }}

# Temporary Table Settings
tmp_table_size = {{ mysql_tmp_table_size }}
max_heap_table_size = {{ mysql_max_heap_table_size }}

# InnoDB Settings - Production Optimized
default_storage_engine = InnoDB
innodb_buffer_pool_size = {{ mysql_innodb_buffer_pool_size }}
innodb_buffer_pool_instances = {{ mysql_innodb_buffer_pool_instances }}
innodb_log_file_size = {{ mysql_innodb_log_file_size }}
innodb_log_files_in_group = 2
innodb_log_buffer_size = 64M
innodb_flush_log_at_trx_commit = 1
innodb_file_per_table = 1
innodb_flush_method = O_DIRECT

# InnoDB Performance Settings
innodb_io_capacity = {{ mysql_innodb_io_capacity }}
innodb_io_capacity_max = {{ mysql_innodb_io_capacity_max }}
innodb_read_io_threads = {{ mysql_innodb_read_io_threads }}
innodb_write_io_threads = {{ mysql_innodb_write_io_threads }}
innodb_thread_concurrency = {{ mysql_innodb_thread_concurrency }}
innodb_purge_threads = 4
innodb_page_cleaners = {{ mysql_innodb_buffer_pool_instances }}

# InnoDB Advanced Settings
innodb_adaptive_hash_index = ON
innodb_change_buffering = all
innodb_old_blocks_time = 1000
innodb_stats_on_metadata = OFF
innodb_file_format = Barracuda
innodb_large_prefix = ON
innodb_strict_mode = ON

# Binary Logging (Required for Group Replication)
log_bin = mysql-bin
binlog_format = ROW
binlog_checksum = NONE
log_slave_updates = ON
gtid_mode = ON
enforce_gtid_consistency = ON
binlog_cache_size = 1M
max_binlog_cache_size = 2G
max_binlog_size = 1G
expire_logs_days = 7
sync_binlog = 1

# Group Replication Settings
plugin_load_add = 'group_replication.so'
group_replication_group_name = "{{ mysql_group_replication_group_name }}"
group_replication_start_on_boot = OFF
group_replication_local_address = "{{ ansible_default_ipv4.address }}:{{ mysql_group_replication_port }}"
group_replication_group_seeds = "{% for host in groups['mysql_cluster'] %}{{ hostvars[host]['ansible_default_ipv4']['address'] }}:{{ mysql_group_replication_port }}{% if not loop.last %},{% endif %}{% endfor %}"
group_replication_bootstrap_group = OFF
group_replication_single_primary_mode = ON
group_replication_enforce_update_everywhere_checks = OFF

# Performance Schema - Production Settings
performance_schema = ON
performance_schema_max_table_instances = 12500
performance_schema_max_table_handles = 4000

# Security Settings
sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER
local_infile = 0
skip_symbolic_links = 1

# Slow Query Log - Production Monitoring
slow_query_log = 1
slow_query_log_file = {{ mysql_logdir }}/mysql-slow.log
long_query_time = 1
log_queries_not_using_indexes = 1
log_throttle_queries_not_using_indexes = 10

# General Log (Disabled by default for performance)
general_log = 0
general_log_file = {{ mysql_logdir }}/mysql-general.log

# Error Log Settings
log_error_verbosity = 2
log_timestamps = SYSTEM

# Replication Settings
relay_log_recovery = ON
slave_preserve_commit_order = ON
slave_parallel_workers = {{ (mysql_innodb_read_io_threads / 2) | int }}
slave_parallel_type = LOGICAL_CLOCK

[mysql]
default_character_set = utf8mb4
auto-rehash = FALSE

[client]
port = {{ mysql_port }}
socket = {{ mysql_datadir }}/mysql.sock
default_character_set = utf8mb4

[mysqldump]
quick
quote_names
max_allowed_packet = 1G

[myisamchk]
key_buffer_size = 512M
sort_buffer_size = 512M
read_buffer = 8M
write_buffer = 8M 